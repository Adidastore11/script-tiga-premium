#!/bin/bash
clear

DB="/etc/ssh/.ssh.db"
SAVE_DIR="/root/home"

# Cek database
if [ ! -f "$DB" ]; then
    echo -e "\033[1;31mDatabase SSH tidak ditemukan!\033[0m"
    exit 1
fi

# Hitung jumlah akun
NUMBER_OF_CLIENTS=$(grep -c -E "^#ssh# " "$DB")
if [[ $NUMBER_OF_CLIENTS -eq 0 ]]; then
    echo -e "\033[1;31mTidak ada akun SSH ditemukan!\033[0m"
    exit 0
fi

# Tampilkan daftar user (tanpa expired)
echo -e "\033[1;36m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
echo -e "           \e[1;97;101m  SSH ACCOUNT LIST  \e[0m"
echo -e "\033[1;36m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
echo "     No  Username"
echo -e "\033[1;36m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"

INDEX=0
declare -a USER_LIST
while read line; do
    user=$(echo "$line" | awk '{print $2}')
    INDEX=$((INDEX + 1))
    printf "     %2s)  %s\n" "$INDEX" "$user"
    USER_LIST+=("$user")
done < <(grep -E "^#ssh# " "$DB")

echo -e "\033[1;36m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"

# Input pilihan
while true; do
    read -rp "Pilih nomor user [1-${NUMBER_OF_CLIENTS}]: " CLIENT_NUMBER
    if [[ $CLIENT_NUMBER -ge 1 && $CLIENT_NUMBER -le $NUMBER_OF_CLIENTS ]]; then
        break
    else
        echo "Input tidak valid. Ulangi."
    fi
done

# Ambil username
user=${USER_LIST[$((CLIENT_NUMBER-1))]}
FILE_PATH="$SAVE_DIR/ssh-${user}.txt"

# Tampilkan isi file lokal
echo -e "\nMenampilkan data dari lokal: $FILE_PATH\n"

if [[ -f "$FILE_PATH" ]]; then
    echo -e "\033[1;92mAkun ditemukan:\033[0m"
    echo -e "\033[1;93m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    cat "$FILE_PATH"
    echo -e "\033[1;93m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
else
    echo -e "\033[1;91mGagal: File tidak ditemukan untuk user '$user'.\033[0m"
fi

echo ""
read -n 1 -s -r -p "Tekan [Enter] untuk kembali ke menu"
menu