#!/bin/bash
# My Telegram : https://t.me/kontolmuashu
# ==========================================
# Warna
RED='\033[0;31m'
NC='\033[0m'
GREEN='\033[0;32m'
ORANGE='\033[0;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
LIGHT='\033[0;37m'
# ==========================================

# Cek apakah file konfigurasi bot ada
CONFIG_FILE="/root/.bckupbot"

if [[ ! -f "$CONFIG_FILE" ]]; then
    echo "File konfigurasi bot belum ada. Silakan masukkan data berikut:"
    read -rp "Masukkan Bot Token: " bottoken
    read -rp "Masukkan Telegram Admin ID: " adminid

    echo "$bottoken" > "$CONFIG_FILE"
    echo "$adminid" >> "$CONFIG_FILE"
else
    # Ambil data dari file
    bottoken=$(sed -n '1p' "$CONFIG_FILE" | awk '{print $1}')
    adminid=$(sed -n '2p' "$CONFIG_FILE" | awk '{print $1}')

    # Jika bot token atau admin ID kosong, minta input ulang
    if [[ -z "$bottoken" || -z "$adminid" ]]; then
        echo "Konfigurasi tidak lengkap. Silakan masukkan ulang:"
        read -rp "Masukkan Bot Token: " bottoken
        read -rp "Masukkan Telegram Admin ID: " adminid

        echo "$bottoken" > "$CONFIG_FILE"
        echo "$adminid" >> "$CONFIG_FILE"
    fi
fi

# Simpan ke variabel
export CHATID="$adminid"
export KEY="$bottoken"
export TIME="10"
export URL="https://api.telegram.org/bot$KEY/sendMessage"

# Mulai proses backup
clear
IP=$(curl -sS ipv4.icanhazip.com)
domain=$(cat /etc/xray/domain)
date=$(date +"%Y-%m-%d")
random_password=$(tr -dc A-Za-z0-9 </dev/urandom | head -c 6)
clear
echo "Mohon Menunggu, Proses Backup sedang berlangsung!"
rm -rf /root/backup
mkdir /root/backup

# Copy file konfigurasi dan database
cp /etc/passwd /root/backup/
cp /etc/group /root/backup/
cp /etc/shadow /root/backup/
cp /etc/gshadow /root/backup/
cp /etc/crontab /root/backup/
cp /etc/ssh/.ssh.db_recovery /root/backup/
cp /etc/vmess/.vmess.db_recovery /root/backup/
cp /etc/vless/.vless.db_recovery /root/backup/
cp /etc/trojan/.trojan.db_recovery /root/backup/
cp /etc/vmess/.vmess.db /root/backup/
cp /etc/ssh/.ssh.db /root/backup/
cp /etc/vless/.vless.db /root/backup/
cp /etc/trojan/.trojan.db /root/backup/
cp /etc/shadowsocks/.shadowsocks.db /root/backup/
cp -r /etc/klmpk/limit /root/backup/
cp -r /etc/vmess /root/backup/
cp -r /etc/trojan /root/backup/
cp -r /etc/vless /root/backup/
cp -r /etc/shadowsock /root/backup/
cp -r /var/lib/klmpk/ /root/backup/klmpk 
cp -r /etc/xray /root/backup/xray
cp -r /var/www/html/ /root/backup/html
cp /root/regis /root/backup/
# Kompresi file backup dengan password
cd /root
backup_name="${IP}-${date}.zip"
password_zip="klmpk-${random_password}"
zip -r -P "$password_zip" "$backup_name" backup > /dev/null 2>&1

# Upload ke Google Drive dengan rclone
rclone copy "/root/$backup_name" dr:backup/
url=$(rclone link "dr:backup/$backup_name")
id=$(echo $url | grep -o 'id=[^&]*' | cut -d'=' -f2)
link="https://drive.google.com/u/4/uc?id=${id}&export=download"

# Hapus file backup dari server
rm -rf /root/backup
rm -r "/root/$backup_name"

# Debugging: Pastikan semua variabel penting tercetak sebelum dikirim ke Telegram
echo "DEBUG: Password ZIP adalah $password_zip"
echo "DEBUG: ID Google Drive adalah $id"
echo "DEBUG: Domain VPS adalah $domain"

# Kirim informasi backup ke Telegram
curl -s --request POST \
    --url "https://api.telegram.org/bot${bottoken}/sendMessage" \
    --header 'Content-Type: application/json' \
    --data "$(cat <<EOF
{
    "chat_id": "${adminid}",
    "text": "ðŸ”¹ *Backup Selesai!*\n\nðŸ“ *IP:* ${IP}\nðŸŒ *Domain:* ${domain}\nðŸ“… *Tanggal:* ${date}\nðŸ”— *Download:* [Klik Disini](${link})\nðŸ”‘ *Password ZIP:* \`${password_zip}\`\nðŸ†” *Google Drive ID:* \`${id}\`",
    "parse_mode": "Markdown",
    "disable_web_page_preview": true
}
EOF
)"

clear
echo -e "
Detail Backup 
==================================
IP VPS        : $IP
Link Backup   : $link
Tanggal       : $date
Domain        : $domain
Password ZIP  : $password_zip
==================================
"
echo "Silahkan copy Link dan restore di VPS baru"
echo "Password ZIP: $password_zip"
echo ""