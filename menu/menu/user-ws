#!/bin/bash
clear

if [[ ! -f /root/.isp ]]; then
curl -sS ipinfo.io/org?token=7a814b6263b02c > /root/.isp
fi
if [[ ! -f /root/.city ]]; then
curl -sS ipinfo.io/city?token=7a814b6263b02c > /root/.city
fi
if [[ ! -f /root/.myip ]]; then
curl -sS ipv4.icanhazip.com > /root/.myip
fi

export IP=$(cat /root/.myip);
export ISP=$(cat /root/.isp);
export CITY=$(cat /root/.city);
domain=$(cat /etc/xray/domain)


# Ambil user hanya dari block "network": "ws"
CLIENT_LIST=$(awk '
/"streamSettings"/ { in_stream = 1 }
/"network"[ \t]*:[ \t]*"ws"/ { in_ws = 1 }
/"network"[ \t]*:[ \t]*"grpc"/ { in_ws = 0 }
/^\s*\]/ { in_ws = 0 }
in_stream && in_ws && /### / { print $0 }
' /etc/xray/config.json | cut -d ' ' -f 2 | sort -u)

NUMBER_OF_CLIENTS=$(echo "$CLIENT_LIST" | wc -l)

if [[ ${NUMBER_OF_CLIENTS} == '0' ]]; then
  echo -e "\033[1;36m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
  echo -e " \e[1;97;101m         CONFIG VMESS ACCOUNT           \e[0m"
  echo -e "\033[1;36m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
  echo ""
  echo "You have no existing clients!"
  echo ""
  echo -e "\033[1;36m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
  read -n 1 -s -r -p "Press [ Enter ] to back on menu vmess"
  vmess
fi

echo -e "\033[1;36m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
echo -e "  \e[1;97;101m        CONFIG VMESS ACCOUNT         \E[0m"
echo -e "\033[1;36m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
echo "     No  Expired   User"

INDEX=0
declare -a USER_LIST
while read user; do
  INDEX=$((INDEX + 1))
  exp=$(grep -E "^### ${user} " /etc/xray/config.json | head -n 1 | cut -d ' ' -f 3)
  printf "     %s)  %s   %s\n" "$INDEX" "$exp" "$user"
  USER_LIST+=("$user")
done <<< "$CLIENT_LIST"

until [[ ${CLIENT_NUMBER} -ge 1 && ${CLIENT_NUMBER} -le ${NUMBER_OF_CLIENTS} ]]; do
  read -rp "Select one client [1-${NUMBER_OF_CLIENTS}]: " CLIENT_NUMBER
done

user=${USER_LIST[$((CLIENT_NUMBER - 1))]}

# Cek dan ambil info Quota
if [[ -f /etc/vmess/$user ]]; then
  raw_quota=$(cat /etc/vmess/$user)
  Quota=$(awk "BEGIN {printf \"%.2f\", $raw_quota / 1073741824}")
else
  Quota="-"
fi

# Cek dan ambil IP limit
[[ -f /etc/klmpk/limit/vmess/ip/$user ]] && iplim=$(cat /etc/klmpk/limit/vmess/ip/$user) || iplim="-"

# UUID dan Expired
uuid=$(grep -E "^### ${user} " /etc/vmess/.vmess.db | head -n 1 | cut -d ' ' -f 4)
exp=$(grep -E "^### ${user} " /etc/xray/config.json | head -n 1 | cut -d ' ' -f 3)

# Hitung masa aktif dan tanggal dibuat
if [[ -n $exp ]]; then
  exp_epoch=$(date -d "$exp" +%s)
  today_epoch=$(date +%s)
  sisa=$(( (exp_epoch - today_epoch) / 86400 ))
  masaaktif=$sisa
  tnggl=$(date -d "$sisa days ago" +"%d %b %Y")
else
  masaaktif="-"
  tnggl="-"
  exp="-"
fi

# JSON link
asu=$(cat <<EOF
{
  "v": "2",
  "ps": "${user}",
  "add": "${domain}",
  "port": "443",
  "id": "${uuid}",
  "aid": "0",
  "net": "ws",
  "path": "/vmess",
  "type": "none",
  "host": "${domain}",
  "tls": "tls"
}
EOF
)

ask=$(cat <<EOF
{
  "v": "2",
  "ps": "${user}",
  "add": "${domain}",
  "port": "80",
  "id": "${uuid}",
  "aid": "0",
  "net": "ws",
  "path": "/vmess",
  "type": "none",
  "host": "${domain}",
  "tls": "none"
}
EOF
)

grpc=$(cat <<EOF
{
  "v": "2",
  "ps": "${user}",
  "add": "${domain}",
  "port": "443",
  "id": "${uuid}",
  "aid": "0",
  "net": "grpc",
  "path": "vmess-grpc",
  "type": "none",
  "host": "${domain}",
  "tls": "tls"
}
EOF
)

# Encode ke base64
vmesslink1="vmess://$(echo "$asu" | base64 -w 0)"
vmesslink2="vmess://$(echo "$ask" | base64 -w 0)"
vmesslink3="vmess://$(echo "$grpc" | base64 -w 0)"

# Simpan link config
cat >/var/www/html/vmess-$user.txt <<-END

◇━━━━━━━━━━━━━━━━━◇
 Dragon Emperor Tunneling 
◇━━━━━━━━━━━━━━━━━◇
# Format Vmess WS TLS

- name: Vmess-$user-WS TLS
  type: vmess
  server: ${domain}
  port: 443
  uuid: ${uuid}
  alterId: 0
  cipher: auto
  udp: true
  tls: true
  skip-cert-verify: true
  servername: ${domain}
  network: ws
  ws-opts:
    path: /vmess
    headers:
      Host: ${domain}

# Format Vmess WS Non TLS

- name: Vmess-$user-WS Non TLS
  type: vmess
  server: ${domain}
  port: 80
  uuid: ${uuid}
  alterId: 0
  cipher: auto
  udp: true
  tls: false
  skip-cert-verify: false
  servername: ${domain}
  network: ws
  ws-opts:
    path: /vmess
    headers:
      Host: ${domain}

# Format Vmess gRPC

- name: Vmess-$user-gRPC (SNI)
  server: ${domain}
  port: 443
  type: vmess
  uuid: ${uuid}
  alterId: 0
  cipher: auto
  network: grpc
  tls: true
  servername: ${domain}
  skip-cert-verify: true
  grpc-opts:
    grpc-service-name: vmess-grpc

◇━━━━━━━━━━━━━━━━━◇
 Link Akun Vmess                   
◇━━━━━━━━━━━━━━━━━◇
Link TLS         : ${vmesslink1}
Link non-TLS     : ${vmesslink2}
Link gRPC        : ${vmesslink3}
◇━━━━━━━━━━━━━━━━━◇

END

# OUTPUT
clear
echo -e "\033[1;93m◇━━━━━━━━━━━━━━━━━◇\033[0m"
echo -e " Xray/Vmess Account "
echo -e "\033[1;93m◇━━━━━━━━━━━━━━━━━◇\033[0m"
echo -e "Remarks          : ${user}"
echo -e "Domain           : ${domain}"
echo -e "User Quota       : ${Quota} GB"
echo -e "User IP          : ${iplim} IP"
echo -e "Port TLS         : 400-900"
echo -e "Port none TLS    : 80, 8080, 8081-9999"
echo -e "id               : ${uuid}"
echo -e "Xray DNS         : ${NS}"
echo -e "Pubkey           : ${PUB}"
echo -e "alterId          : 0"
echo -e "Security         : auto"
echo -e "Network          : ws"
echo -e "Path             : /Multi-Path"
echo -e "ServiceName      : vmess-grpc"
echo -e "\033[0;34m◇━━━━━━━━━━━━━━━━━◇\033[0m"
echo -e "Link TLS         : ${vmesslink1}"
echo -e "Link none TLS    : ${vmesslink2}"
echo -e "Link GRPC        : ${vmesslink3}"
echo -e "Format OpenClash : https://${domain}:81/vmess-$user.txt"
echo -e "Aktif Selama     : $masaaktif Hari"
echo -e "Dibuat Pada      : $tnggl"
echo -e "Berakhir Pada    : $exp"
echo -e "\033[0;34m◇━━━━━━━━━━━━━━━━━◇\033[0m"
echo ""
read -n 1 -s -r -p "Press [ Enter ] to back on menu"
menu