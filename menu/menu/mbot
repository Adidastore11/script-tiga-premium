#!/bin/bash
# COLOR VALIDATION
clear
RED='\033[0;31m'
NC='\033[0m'
gray="\e[1;30m"
Blue="\033[0;34m"
green='\033[0;32m'
grenbo="\e[92;1m"
YELL='\033[0;33m'
red() { echo -e "\\033[32;1m${*}\\033[0m"; }
# Getting
MYIP=$(curl -sS ipv4.icanhazip.com)
echo -e "\e[32mloading...\e[0m"
clear
IP=$(wget -qO- icanhazip.com)
dateToday=$(date +"%Y-%m-%d")
Name=$(curl https://raw.githubusercontent.com/Adidastore11/izin/main/ip | grep $MYIP | awk '{print $2}')

setup_bot() {
    switch=$(grep -i "switch" /root/.bckupbot | awk '{print $2}')
    echo "Pergi ke @BotFather dan type /newbot untuk membuat bot baru"
    echo "Pergi ke @MissRose_bot dan type /id untuk mendapatkan ID telegram"
    echo ""
    read -p "Bot Token : " getToken
    read -p "Admin ID  : " adminID
    echo "$getToken" >/root/.bckupbot
    echo "$adminID" >>/root/.bckupbot
    echo "switch $switch" >>/root/.bckupbot
    read -n 1 -s -r -p "Press any key to back on Bot menu"
    botbckpBot_menu
}

botBackup() {
    bottoken=$(sed -n '1p' /root/.bckupbot | awk '{print $1}')
    adminid=$(sed -n '2p' /root/.bckupbot | awk '{print $1}')
    dateToday=$(date +"%Y-%m-%d")
    IP=$(curl -s ifconfig.me)
    BackupFile="$IP-$dateToday.zip"

    echo -e "[INFO] Membuat password untuk backup"
    read -t 10 -p "Masukkan password (default: Adidastore11): " InputPass
    InputPass=${InputPass:-Adidastore11}

    echo -e "[INFO] Memulai backup data VPS..."
    mkdir -p /root/backup
    cp /etc/passwd /root/backup/
    cp /etc/group /root/backup/
    cp /etc/shadow /root/backup/
    cp /etc/gshadow /root/backup/
    cp -r /etc/xray /root/backup/
    cp -r /var/lib/klmpk/ /root/backup/klmpk
    cp -r /var/www/html/ /root/backup/html

    cd /root
    zip -rP "$InputPass" "$BackupFile" backup > /dev/null 2>&1

    echo -e "[INFO] Mengunggah ke Google Drive..."
    rclone copy "/root/$BackupFile" dr:backup/

    # Dapatkan link file dari Google Drive
    url=$(rclone link dr:backup/$BackupFile)
    id=$(echo "$url" | grep -o 'id=.*' | cut -d'=' -f2)
    link="https://drive.google.com/u/4/uc?id=${id}&export=download"

    # Kirim backup info ke Telegram
    curl -s --request POST \
        --url "https://api.telegram.org/bot${bottoken}/sendMessage" \
        --header 'content-type: application/json' \
        --data '{
            "chat_id": "'${adminid}'",
            "text": "Backup Selesai!\n\nIP: '${IP}'\nTanggal: '${dateToday}'\nDownload: '${link}'",
            "parse_mode": "HTML"
        }'

    echo -e "[INFO] Backup selesai!"
    rm -rf /root/backup /root/$BackupFile
}

restoreBot() {
    echo "Silahkan Masukkan Link Google Drive (ID atau URL lengkap):"
    read -rp "Link File: " -e url

    if [[ -z "$url" ]]; then
        echo -e "[ERROR] Link tidak boleh kosong!"
        return
    fi

    if [[ "$url" != https://* ]]; then
        url="https://drive.google.com/uc?id=$url"
    fi

    echo -e "[INFO] Mengunduh file backup dari Google Drive..."
    gdown "$url" -O backup.zip

    if [[ ! -f "backup.zip" ]]; then
        echo -e "[ERROR] Gagal mengunduh file backup!"
        return
    fi

    echo "Masukkan password untuk file ZIP:"
    read -s -rp "Password: " zip_password
    echo ""

    echo -e "[INFO] Ekstrak file backup..."
    unzip -P "$zip_password" backup.zip -d /root/backup/ >/dev/null 2>&1

    if [[ $? -ne 0 ]]; then
        echo -e "[ERROR] Gagal mengekstrak file! Pastikan password benar."
        rm -f backup.zip
        return
    fi

    rm -f backup.zip
    BACKUP_DIR="/root/backup/backup"

    echo -e "[INFO] Mulai Restore..."

    # Daftar file/direktori yang ingin direstore
    declare -A restore_targets=(
        ["$BACKUP_DIR/passwd"]="/etc/"
        ["$BACKUP_DIR/group"]="/etc/"
        ["$BACKUP_DIR/shadow"]="/etc/"
        ["$BACKUP_DIR/gshadow"]="/etc/"
        ["$BACKUP_DIR/crontab"]="/etc/"
        ["$BACKUP_DIR/.ssh.db"]="/etc/ssh/"
        ["$BACKUP_DIR/.vmess.db"]="/etc/vmess/"
        ["$BACKUP_DIR/.vless.db"]="/etc/vless/"
        ["$BACKUP_DIR/.trojan.db"]="/etc/trojan/"
        ["$BACKUP_DIR/.shadowsocks.db"]="/etc/shadowsocks/"
    )

    for src in "${!restore_targets[@]}"; do
        dest="${restore_targets[$src]}"
        if [[ -f "$src" ]]; then
            cp "$src" "$dest"
            echo "[RESTORE] File $(basename "$src") â†’ $dest"
        fi
    done

    # Direktori
    declare -A restore_dirs=(
        ["$BACKUP_DIR/klmpk"]="/var/lib/"
        ["$BACKUP_DIR/xray"]="/etc/"
        ["$BACKUP_DIR/html"]="/var/www/"
        ["$BACKUP_DIR/limit"]="/etc/klmpk/"
        ["$BACKUP_DIR/vmess"]="/etc/"
        ["$BACKUP_DIR/trojan"]="/etc/"
        ["$BACKUP_DIR/vless"]="/etc/"
    )

    for dir_src in "${!restore_dirs[@]}"; do
        dir_dest="${restore_dirs[$dir_src]}"
        if [[ -d "$dir_src" ]]; then
            cp -r "$dir_src" "$dir_dest"
            echo "[RESTORE] Folder $(basename "$dir_src") â†’ $dir_dest"
        fi
    done

    echo -e "[INFO] Restore selesai!"
    rm -rf /root/backup
}

autoBackup() {
    switch=$(grep -i "switch" /root/.bckupbot | awk '{print $2}')
    if [ "${switch}" == "on" ]; then
        sed -i 's/switch on/switch off/g' /root/.bckupbot
        sed -i "/googlebotbackup.sh/d" /etc/crontab
        service cron restart >/dev/null 2>&1
        echo -e "[INFO] Auto Backup Dimatikan!"
    else
        sed -i 's/switch off/switch on/g' /root/.bckupbot

        echo -e "[INFO] Buat jadwal backup otomatis"
        echo -n "Backup setiap berapa jam? (0 untuk skip): "
        read jam
        echo -n "Backup setiap berapa hari? (0 untuk skip): "
        read hari

        echo -e "[INFO] Membuat file backup otomatis..."
        cat <<EOF > /root/googlebotbackup.sh
#!/bin/bash
IP=\$(curl -s ifconfig.me)
dateToday=\$(date +"%Y-%m-%d")
BackupFile="googlebotbackup-\${IP}-\${dateToday}.zip"

bottoken=\$(sed -n '1p' /root/.bckupbot | awk '{print \$1}')
adminid=\$(sed -n '2p' /root/.bckupbot | awk '{print \$1}')

echo -e "[INFO] Memulai backup data VPS..."
mkdir -p /root/backup
cp /etc/passwd /root/backup/
cp /etc/group /root/backup/
cp /etc/shadow /root/backup/
cp /etc/gshadow /root/backup/
cp -r /etc/xray /root/backup/
cp -r /var/lib/klmpk/ /root/backup/klmpk
cp -r /var/www/html/ /root/backup/html

cd /root
zip -rP "Adidastore11" "\$BackupFile" backup > /dev/null 2>&1

echo -e "[INFO] Mengunggah ke Google Drive..."
rclone copy "/root/\$BackupFile" dr:backup/

url=\$(rclone link dr:backup/\$BackupFile)
id=\$(echo "\$url" | grep -o 'id=.*' | cut -d'=' -f2)
link="https://drive.google.com/u/4/uc?id=\${id}&export=download"

curl -s --request POST \
    --url "https://api.telegram.org/bot\${bottoken}/sendMessage" \
    --header 'content-type: application/json' \
    --data '{
        "chat_id": "'\${adminid}'",
        "text": "âœ… *Backup Selesai!*\n\nðŸ”¹ *IP:* '\${IP}'\nðŸ“… *Tanggal:* '\${dateToday}'\nðŸ”— *Download:* [Klik Disini]('\${link}')",
        "parse_mode": "Markdown"
    }'

echo -e "[INFO] Backup selesai!"
rm -rf /root/backup /root/\$BackupFile
EOF

        chmod +x /root/googlebotbackup.sh

        # Hapus jadwal lama
        sed -i "/googlebotbackup.sh/d" /etc/crontab

        # Tambahkan jadwal baru sesuai input user
        if [[ "$jam" -gt 0 ]]; then
            echo "0 */$jam * * * root /root/googlebotbackup.sh" >> /etc/crontab
            echo -e "[INFO] Backup akan berjalan setiap $jam jam!"
        fi

        if [[ "$hari" -gt 0 ]]; then
            echo "0 0 */$hari * * root /root/googlebotbackup.sh" >> /etc/crontab
            echo -e "[INFO] Backup akan berjalan setiap $hari hari!"
        fi

        service cron restart >/dev/null 2>&1
        echo -e "[INFO] Auto Backup Diaktifkan!"
    fi
    sleep 1
    read -n 1 -s -r -p "Tekan tombol apa saja untuk kembali ke menu"
    botbckpBot_menu
}

setBackupSchedule() {
    clear
    echo -e "=========================="
    echo -e "    Pengaturan Jadwal Backup"
    echo -e "=========================="
    echo -e ""
    echo -e "1. Setiap Hari Pukul 00:00"
    echo -e "2. Setiap 6 Jam Sekali"
    echo -e "3. Setiap 12 Jam Sekali"
    echo -e "4. Setiap Minggu Sekali"
    echo -e "5. Custom Jadwal (Format Cron)"
    echo -e "6. Kembali ke Menu"
    echo -e ""
    read -p "Pilih opsi (1-6): " option

    case $option in
        1)
            schedule="0 0 * * *"  # Setiap hari pukul 00:00
            ;;
        2)
            schedule="0 */6 * * *"  # Setiap 6 jam sekali
            ;;
        3)
            schedule="0 */12 * * *"  # Setiap 12 jam sekali
            ;;
        4)
            schedule="0 0 * * 0"  # Setiap minggu (Minggu pukul 00:00)
            ;;
        5)
            read -p "Masukkan jadwal dalam format cron (contoh: 30 2 * * *): " custom_schedule
            schedule="$custom_schedule"
            ;;
        6)
            botbckpBot_menu
            return
            ;;
        *)
            echo -e "[ERROR] Pilihan tidak valid!"
            sleep 1
            setBackupSchedule
            return
            ;;
    esac

    # Hapus jadwal lama
    sed -i "/googlebotbackup.sh/d" /etc/crontab

    # Tambahkan jadwal baru
    echo "$schedule root /root/googlebotbackup.sh" >> /etc/crontab

    service cron restart >/dev/null 2>&1
    echo -e "[INFO] Jadwal Backup Telah Diperbarui!"
    sleep 2
    botbckpBot_menu
}
change_bot_credentials() {
    echo "Masukkan Token Bot Baru:"
    read -p "Bot Token: " newToken
    echo "Masukkan ID Telegram Admin Baru:"
    read -p "Admin ID: " newAdminID

    # Simpan ke file konfigurasi
    echo "$newToken" > /root/.bckupbot
    echo "$newAdminID" >> /root/.bckupbot
    echo "switch off" >> /root/.bckupbot

    echo -e "[INFO] Token Bot dan ID Admin berhasil diperbarui!"
    sleep 2
    botbckpBot_menu
}
botbckpBot_menu() {
    switch=$(grep -i "switch" /root/.bckupbot | awk '{print $2}')
    clear
    if [ "${switch}" == "on" ]; then
        sts="\033[0;32m[On]\033[0m"
    else
        sts="\033[1;31m[Off]\033[0m"
    fi
	echo -e " ${Blue}â•­â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•®${NC}"
	echo -e " ${Blue}â”‚$NC\033[41m               Telegram Bot (AutoBackup)               \E[0m"
	echo -e " ${Blue}â•°â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¯${NC}"
    echo -e " ${Blue}â•­â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•®${NC}"
    echo -e " ${Blue}â”‚$NC ${green} VPS Data Backup By Adidastore11"
    echo -e " ${Blue}â”‚$NC"
    echo -e " ${Blue}â”‚$NC [${green}1${NC}] Setup Bot Telegram \e[0m"
    echo -e " ${Blue}â”‚$NC [${green}2${NC}] Auto Backup Status \e[0m"
    echo -e " ${Blue}â”‚$NC [${green}3${NC}] Backup VPS (Telegram Bot) \e[0m"
    echo -e " ${Blue}â”‚$NC [${green}4${NC}] Restore Data \e[0m"
    echo -e " ${Blue}â”‚$NC [${green}5${NC}] Atur Jadwal Backup \e[0m"
    echo -e " ${Blue}â”‚$NC [${green}6${NC}] Ganti TOKEN & ID ADMIN \e[0m"
    echo -e " ${Blue}â”‚$NC [${green}7${NC}] Back To Main Menu \e[0m"
    echo -e " ${Blue}â•°â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¯${NC}"
    echo -e ""
    echo -ne "Select From Options [ 1 - 5 ] : "
    read botch
    case "$botch" in
    1)
        clear
        setup_bot
        ;;
    2)
        clear
        autoBackup
        ;;
    3)
        clear
        botBackup
        ;;
    4)
        clear
        restoreBot
        ;;
    5)
        setBackupSchedule
        ;;
    6)
        change_bot_credentials
        ;;
    7)
        menu
        ;;                
    *)
        menu
        ;;
    esac
}
clear
[[ ! -f /root/.bckupbot ]] && {
    echo "Please Input Bot Details First"
    sleep 2
    clear
    read -p "Bot Token : " getToken
    read -p "Admin ID  : " adminID
    echo "$getToken" >/root/.bckupbot
    echo "$adminID" >>/root/.bckupbot
    echo "switch off" >>/root/.bckupbot
}

botbckpBot_menu