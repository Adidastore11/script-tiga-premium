#!/bin/bash
# Restore akun Trojan dari database recovery

RECOVERY_DB="/etc/trojan/.trojan.db_recovery"
LIMIT_DIR="/etc/klmpk/limit/trojan/ip"
TROJAN_DIR="/etc/trojan"
domain=$(cat /etc/xray/domain)
CITY=$(cat /root/.city)
ISP=$(cat /root/.isp)

echo -e "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo -e "     Restore Akun Trojan       "
echo -e "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
read -p "Masukkan Username: " user

DATA=$(grep -w "^### $user" "$RECOVERY_DB")
if [[ -z "$DATA" ]]; then
  echo -e "❌ Username tidak ditemukan di database recovery."
  exit 1
fi

uuid=$(echo "$DATA" | awk '{print $4}')

read -p "Expired Baru (hari): " masaaktif
read -p "Quota Baru (GB): " Quota
read -p "Limit IP Baru: " iplimit

exp=$(date -d "$masaaktif days" +"%Y-%m-%d")
tgl=$(date -d "$masaaktif days" +"%d")
bln=$(date -d "$masaaktif days" +"%b")
thn=$(date -d "$masaaktif days" +"%Y")
expe="$tgl $bln, $thn"
tgl2=$(date +"%d")
bln2=$(date +"%b")
thn2=$(date +"%Y")
tnggl="$tgl2 $bln2, $thn2"

# Tambahkan kembali ke config.json
sed -i '/#trojanws$/a\#! '"$user $exp"'\
},{"password": "'$uuid'","email": "'$user'"' /etc/xray/config.json
sed -i '/#trojangrpc$/a\#! '"$user $exp"'\
},{"password": "'$uuid'","email": "'$user'"' /etc/xray/config.json

# Quota
[ -d "$TROJAN_DIR" ] || mkdir -p "$TROJAN_DIR"
if [[ "$Quota" != "0" ]]; then
  d=$((${Quota} * 1024 * 1024 * 1024))
  echo "$d" > $TROJAN_DIR/$user
fi

# IP Limit
[ -d "$LIMIT_DIR" ] || mkdir -p "$LIMIT_DIR"
echo "$iplimit" > "$LIMIT_DIR/$user"

# Update database utama
grep -vwE "^### $user" "$TROJAN_DIR/.trojan.db" > /tmp/.temp_restore
mv /tmp/.temp_restore "$TROJAN_DIR/.trojan.db"
echo "### $user $exp $uuid $Quota $iplimit" >> "$TROJAN_DIR/.trojan.db"

# Update recovery DB
grep -vwE "^### $user" "$RECOVERY_DB" > /tmp/.temp_restore2
mv /tmp/.temp_restore2 "$RECOVERY_DB"
echo "### $user $exp $uuid $Quota $iplimit active" >> "$RECOVERY_DB"

# Buat link trojan
trojanlink="trojan://${uuid}@${domain}:443?path=%2Ftrojan-ws&security=tls&host=${domain}&type=ws&sni=${domain}#${user}"
trojanlink1="trojan://${uuid}@${domain}:443?mode=gun&security=tls&type=grpc&serviceName=trojan-grpc&sni=${domain}#${user}"
trojanlink2="trojan://${uuid}@${domain}:80?path=%2Ftrojan-ws&security=none&host=${domain}&type=ws#${user}"

# Output
clear
echo -e ""
echo -e "\033[1;93m---------------------------------------------------\033[0m"
echo -e " RESTORE TROJAN ACCOUNT          "
echo -e "\033[1;93m---------------------------------------------------\033[0m"
echo -e "Remarks          : ${user}" 
echo -e "Host/IP          : ${domain}"
echo -e "User Quota       : ${Quota} GB"
echo -e "User IP Limit    : ${iplimit} IP"
echo -e "Port TLS         : 443"
echo -e "Port NTLS        : 80, 8080, 8880" 
echo -e "UUID/Password    : ${uuid}" 
echo -e "Location         : $CITY"
echo -e "ISP              : $ISP"
echo -e "Path             : /trojan-ws" 
echo -e "ServiceName      : trojan-grpc" 
echo -e "\033[0;34m---------------------------------------------------\033[0m" 
echo -e "Link WS          : ${trojanlink}" 
echo -e "\033[0;34m---------------------------------------------------\033[0m" 
echo -e "Link None TLS    : ${trojanlink2}" 
echo -e "\033[0;34m---------------------------------------------------\033[0m" 
echo -e "Link GRPC        : ${trojanlink1}" 
echo -e "\033[0;34m---------------------------------------------------\033[0m" 
echo -e "Format OpenClash : https://${domain}:81/trojan-$user.txt" 
echo -e "\033[0;34m---------------------------------------------------\033[0m" 
echo -e "Aktif Selama     : $masaaktif Hari"
echo -e "Dibuat Pada      : $tnggl"
echo -e "Berakhir Pada    : $expe" 
echo -e "----------------------------------------------------------------------"
echo -e "       Terima Kasih Telah Menggunakan     "
echo -e "           Premium Script                     "
echo -e "        Andyyuda Tunneling             "
echo -e "----------------------------------------------------------------------"

# Simpan file
hasil_trojan=$(cat <<EOF
Link WS        : $trojanlink
Link Non TLS   : $trojanlink2
Link gRPC      : $trojanlink1
Expired        : $exp
Quota          : ${Quota} GB
Limit IP       : ${iplimit}
EOF
)
echo "$hasil_trojan" > /root/home/trojan-$user.txt