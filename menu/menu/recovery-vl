#!/bin/bash
# Restore akun VLESS dari database recovery

RECOVERY_DB="/etc/vless/.vless.db_recovery"
LIMIT_DIR="/etc/klmpk/limit/vless/ip"
VLESS_DIR="/etc/vless"

domain=$(cat /etc/xray/domain)
NS=$(cat /etc/xray/dns)
PUB=$(cat /etc/slowdns/server.pub)
CITY=$(cat /root/.city)
ISP=$(cat /root/.isp)
IP=$(cat /root/.myip)

echo -e "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo -e "     Restore Akun VLESS       "
echo -e "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
read -p "Masukkan Username: " user

DATA=$(grep -w "^### $user" "$RECOVERY_DB")
if [[ -z "$DATA" ]]; then
  echo -e "❌ Username tidak ditemukan di database recovery."
  exit 1
fi

uuid=$(echo "$DATA" | awk '{print $4}')

read -p "Expired Baru (hari): " masaaktif
read -p "Quota Baru (GB): " Quota
read -p "Limit IP Baru: " iplimit

exp=$(date -d "$masaaktif days" +"%Y-%m-%d")
tgl=$(date -d "$masaaktif days" +"%d")
bln=$(date -d "$masaaktif days" +"%b")
thn=$(date -d "$masaaktif days" +"%Y")
expe="$tgl $bln, $thn"
tgl2=$(date +"%d")
bln2=$(date +"%b")
thn2=$(date +"%Y")
tnggl="$tgl2 $bln2, $thn2"

# Tambah ke config
sed -i '/#vless$/a\#& '"$user $exp"'\
},{"id": "'$uuid'","email": "'$user'"' /etc/xray/config.json
sed -i '/#vlessgrpc$/a\#& '"$user $exp"'\
},{"id": "'$uuid'","email": "'$user'"' /etc/xray/config.json

# Quota
[ -d "$VLESS_DIR" ] || mkdir -p "$VLESS_DIR"
if [[ "$Quota" != "0" ]]; then
  d=$((${Quota} * 1024 * 1024 * 1024))
  echo "$d" > $VLESS_DIR/$user
fi

# IP Limit
[ -d "$LIMIT_DIR" ] || mkdir -p "$LIMIT_DIR"
echo "$iplimit" > "$LIMIT_DIR/$user"

# Update database utama
grep -vwE "^### $user" "$VLESS_DIR/.vless.db" > /tmp/.temp
mv /tmp/.temp "$VLESS_DIR/.vless.db"
echo "### $user $exp $uuid $Quota $iplimit" >> "$VLESS_DIR/.vless.db"

# Update status di recovery
grep -vwE "^### $user" "$RECOVERY_DB" > /tmp/.temp_restore
mv /tmp/.temp_restore "$RECOVERY_DB"
echo "### $user $exp $uuid $Quota $iplimit active" >> "$RECOVERY_DB"

# Buat link VLESS
vlesslink1="vless://${uuid}@${domain}:443?path=/vless&security=tls&encryption=none&type=ws#${user}"
vlesslink2="vless://${uuid}@${domain}:80?path=/vless&encryption=none&type=ws#${user}"
vlesslink3="vless://${uuid}@${domain}:443?mode=gun&security=tls&encryption=none&type=grpc&serviceName=vless-grpc&sni=${domain}#${user}"

# Output hasil
clear
echo -e ""
echo -e "\033[1;93m---------------------------------------------------\033[0m"
echo -e " RESTORE VLESS ACCOUNT           "
echo -e "\033[1;93m---------------------------------------------------\033[0m"
echo -e "Remarks     : ${user}"
echo -e "Domain      : ${domain}"
echo -e "User Quota  : ${Quota} GB"
echo -e "User IP     : ${iplimit} IP"
echo -e "Port TLS    : 443-900"
echo -e "Port NTLS   : 80,8080,8880"
echo -e "User ID     : ${uuid}"
echo -e "Location    : $CITY"
echo -e "ISP         : $ISP"
echo -e "Encryption  : none"
echo -e "Path TLS    : /vless"
echo -e "ServiceName : vless-grpc"
echo -e "\033[1;93m---------------------------------------------------\033[0m"
echo -e "Link TLS    : ${vlesslink1}"
echo -e "\033[1;93m---------------------------------------------------\033[0m"
echo -e "Link NTLS   : ${vlesslink2}"
echo -e "\033[1;93m---------------------------------------------------\033[0m"
echo -e "Link GRPC   : ${vlesslink3}"
echo -e "\033[1;93m---------------------------------------------------\033[0m"
echo -e "Format OpenClash : https://${domain}:81/vless-$user.txt"
echo -e "\033[1;93m---------------------------------------------------\033[0m"
echo -e "Aktif Selama     : $masaaktif Hari"
echo -e "Dibuat Pada      : $tnggl"
echo -e "Berakhir Pada    : $expe"
echo -e "----------------------------------------------------------------------"
echo -e "       Terima Kasih Telah Menggunakan     "
echo -e "               Premium Script                  "
echo -e "        Andyyuda Tunneling             "
echo -e "----------------------------------------------------------------------"

# Simpan file
hasil_vless=$(cat <<EOF
Link TLS    : $vlesslink1
Link NTLS   : $vlesslink2
Link gRPC   : $vlesslink3
Expired     : $exp
Quota       : $Quota GB
Limit IP    : $iplimit
EOF
)
echo "$hasil_vless" > /root/home/vless-$user.txt