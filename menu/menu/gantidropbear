#!/bin/bash

# Warna
YELLOW='\033[1;33m'
GREEN='\033[1;32m'
NC='\033[0m'

# Spinner loading
spinner() {
    local pid=$!
    local delay=0.1
    local spinstr='|/-\'
    while ps -p $pid &>/dev/null; do
        local temp=${spinstr#?}
        printf " [%c]  " "$spinstr"
        local spinstr=$temp${spinstr%"$temp"}
        sleep $delay
        printf "\b\b\b\b\b\b"
    done
    printf "    \b\b\b\b"
}

# Fungsi ganti versi Dropbear
ganti_dropbear() {
    local VER=$1
    declare -A DROPBEAR_URLS
    DROPBEAR_URLS["2016"]="https://matt.ucc.asn.au/dropbear/releases/dropbear-2016.74.tar.bz2"
    DROPBEAR_URLS["2017"]="https://matt.ucc.asn.au/dropbear/releases/dropbear-2017.75.tar.bz2"
    DROPBEAR_URLS["2018"]="https://matt.ucc.asn.au/dropbear/releases/dropbear-2018.76.tar.bz2"
    DROPBEAR_URLS["2019"]="https://matt.ucc.asn.au/dropbear/releases/dropbear-2019.78.tar.bz2"
    DROPBEAR_URLS["2020"]="https://matt.ucc.asn.au/dropbear/releases/dropbear-2020.81.tar.bz2"

    URL=${DROPBEAR_URLS[$VER]}
    if [[ -z "$URL" ]]; then
        echo "âŒ Versi tidak tersedia."
        return
    fi

    echo -e "\n[+] Mengganti ke Dropbear $VER...\n"

    (
    apt install build-essential zlib1g-dev libtomcrypt-dev libtommath-dev -y >/dev/null 2>&1
    cd /tmp || exit
    rm -rf dropbear-* dropbear.tar.bz2
    wget -q -O dropbear.tar.bz2 "$URL" >/dev/null
    tar -xjf dropbear.tar.bz2 >/dev/null
    cd dropbear-* || exit
    ./configure >/dev/null
    make PROGRAMS="dropbear" > /dev/null 2>&1
    systemctl stop dropbear
    cp /usr/sbin/dropbear /usr/sbin/dropbear_backup_$(date +%F) 
    cp dropbear /usr/sbin/dropbear
    chmod 755 /usr/sbin/dropbear
    systemctl start dropbear
    ) & spinner

    echo -e "\nâœ… Sukses diganti ke versi:"
    /usr/sbin/dropbear -V
    echo ""
    read -n 1 -s -r -p "Tekan tombol apapun untuk kembali ke menu..."
}

# Fungsi restart Dropbear
restart_dropbear() {
    systemctl restart dropbear
    echo -e "\nâœ… Dropbear berhasil direstart!"
    read -n 1 -s -r -p "Tekan tombol apapun untuk kembali ke menu..."
}

# Menu utama
main_menu() {
while true; do
clear

# Cek status service
SERVICE_STATUS=$(systemctl is-active dropbear 2>/dev/null)

# Tampilkan menu
echo -e "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo -e "â”‚        ${YELLOW}KLMPK Tunneling${NC}        â”‚"
echo -e "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
VERSION=$(dropbear -V)
echo -e " Service : ${GREEN}${SERVICE_STATUS^^}${NC}"
echo ""
echo -e " 1.) Dropbear 2016"
echo -e " 2.) Dropbear 2017"
echo -e " 3.) Dropbear 2018"
echo -e " 4.) Dropbear 2019"
echo -e " 5.) Dropbear 2020"
echo -e " 6.) Dropbear Default System"
echo -e " 7.) Restart Dropbear"
echo -e " 8.) Back to Menu"
echo -e " x.) Exit"
echo ""
read -p " Select from options [1-8 or x] : " opt
case $opt in
    1) ganti_dropbear 2016 ;;
    2) ganti_dropbear 2017 ;;
    3) ganti_dropbear 2018 ;;
    4) ganti_dropbear 2019 ;;
    5) ganti_dropbear 2020 ;;
    6) echo -e "â³ Fitur restore default belum tersedia." && sleep 2 ;;
    7) restart_dropbear ;;
    8) echo "ğŸ” Kembali ke menu utama..."; sleep 1 ;;
    x|X) echo "ğŸšª Keluar..."; exit 0 ;;
    *) echo "âŒ Pilihan tidak valid"; sleep 1 ;;
esac
done
}

# Jalankan menu
main_menu
