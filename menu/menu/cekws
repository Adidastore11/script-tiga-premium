#!/usr/bin/env bash

# Define color codes for esthetic design
DF='\e[39m'
Bold='\e[1m'
yell='\e[33m'
red='\e[31m'
green='\e[32m'
blue='\e[34m'
PURPLE='\e[35m'
cyan='\e[36m'
Lred='\e[91m'
Lgreen='\e[92m'
Lyellow='\e[93m'
NC='\e[0m'
header_color='\e[1;96m' # Cyan bold
line_color='\e[1;94m'   # Blue bold
highlight='\e[1;97;41m' # White on red background
banner_color='\e[1;92m' # Light green bold

# Clear screen
echo -ne "\033c"

# Function: convert bytes to human-readable format
con() {
    bytes=$1
    if [ "$bytes" -lt 1024 ]; then
        echo "${bytes}B"
    elif [ "$bytes" -lt $((1024 * 1024)) ]; then
        echo "$(( (bytes + 1023) / 1024 ))KB"
    elif [ "$bytes" -lt $((1024 * 1024 * 1024)) ]; then
        echo "$(( (bytes + 1048575) / 1048576 ))MB"
    else
        echo "$(( (bytes + 1073741823) / 1073741824 ))GB"
    fi
}

# Read VMess users from config.json
mapfile -t users < <(grep -F '###' /etc/xray/config.json | awk '{print $2}' | sort -u)

# Header
printf "%b━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━%b\n" "$line_color" "$NC"
echo -e " ${highlight}                           CEK VMESS ACCOUNT                              ${NC}"
printf "%b━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━%b\n" "$line_color" "$NC"
printf "${header_color}%-15s %-20s %-15s %-15s %-10s\n${NC}" \
    "USERNAME" "LOGIN" "USAGE QUOTA" "LIMIT QUOTA" "LIMIT IP"
printf "%b━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━%b\n" "$line_color" "$NC"

# Loop through each user, only show if they have at least one login
for user in "${users[@]}"; do
    # Skip if user is empty
    [ -z "$user" ] && continue

    # Collect unique IPs for this user from last 500 lines
    mapfile -t ip_list < <(
        grep -F -w "$user" /var/log/xray/access.log | tail -n500 \
            | awk '{print $3}' \
            | sed 's|tcp://||g; s|:.*||g' \
            | sort -u | grep -v "^$"
    )
    count=${#ip_list[@]}
    if [ "$count" -eq 0 ]; then
        continue
    fi

    # Read limit IP count
    iplimit_file="/etc/klmpk/limit/vmess/ip/$user"
    iplimit=$([ -f "$iplimit_file" ] && cat "$iplimit_file" || echo "-")

    # Read limit quota (bytes)
    limit_file="/etc/vmess/$user"
    limit_bytes=$([ -f "$limit_file" ] && cat "$limit_file" || echo "0")
    limit_quota=$(con "$limit_bytes")

    # Read usage quota (bytes)
    usage_file="/etc/limit/vmess/$user"
    usage_bytes=$([ -f "$usage_file" ] && cat "$usage_file" || echo "0")
    usage_quota=$(con "$usage_bytes")

    # Print user info line
    printf "${green}%-15s ${blue}%-20s ${cyan}%-15s ${PURPLE}%-15s ${red}%-10s\n${NC}" \
        "$user" "$count IP" "$usage_quota" "$limit_quota" "$iplimit IP"
done

# Footer
printf "%b━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━%b\n" "$line_color" "$NC"
echo ""
# Banner
echo -e "${banner_color}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "                  ${Bold}${cyan}Selamat menggunakan script by Andyyuda${NC}"
echo -e "${banner_color}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
